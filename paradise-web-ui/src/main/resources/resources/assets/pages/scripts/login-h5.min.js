var Login = function(){
	
	var b = function(){
		$("#register-btn").click(function() {
			$(".login-form").hide(),
			$(".register-form").show()
		}),
        $("#register-back-btn").click(function() {
        	$(".login-form").show(),
        	$(".register-form").hide()
        }),
        $("#forget-password").click(function() {
            $(".login-form").hide(),
            $(".forget-form").show()
        }),
        $("#back-btn").click(function() {
            $(".login-form").show(),
            $(".forget-form").hide()
        })
	};
	
	var e = function() {
    	
	    var elements = $(".login-form").find("input");
	    for (var i = 0; i < elements.length; i++) {
	        elements[i].oninvalid = function(e) {
	            e.target.setCustomValidity("");
	            if (!e.target.validity.valid) {
	                e.target.setCustomValidity(e.target.placeholder + "不能为空！");
	            }
	        };
	        elements[i].oninput = function(e) {
	            e.target.setCustomValidity("");
	        };
	    }
		
    	$(".login-form input").keypress(function(e) {
			if(13 == e.which){
				$("#submitform").trigger("click");
			}
			
        });
        
        $(".login-form").bind("submit", function(e){
        	e.preventDefault();
        	var userName = $("#username").val();
        	var password = $("#password").val();
        	var verifycode = $("#verifycode").val();
        	var rememberChkBox = $("#remember");
        	
        	var remember = rememberChkBox[0].checked == true ? 1 : 0;
        	var formData = {"userName":userName,"password":password,"verifyCode":verifycode,"remember":remember};
        	$.ajax({
        		
        		type:"post",
        		url:"loginCheck.action",
        		dataType:"json",
        		contentType:"application/json",
        		data:JSON.stringify(formData),
        		success:function(result){
        			if(result.status != 0){
        				$(".alert-danger").find("span").html(result.message);
        				$(".alert-danger").fadeIn();
        				change_verify_code();
        				setTimeout(function(){
        					$(".alert-danger").fadeOut();
        				},3000);
        			}
        			else{
        				$(".alert-danger").find("span").html("ok");
        				$(".alert-danger").fadeIn();
        				change_verify_code();
        				setTimeout(function(){
        					$(".alert-danger").fadeOut();
        				},3000);
        			}
        		},
        		error:function(result){
        			console.log(result);
        		}
        		
        	});
        }),
        
        $("#change_code").click(function(){
        	
        	change_verify_code();

        }),
        
        change_verify_code = function(){
    		
    		var img = $("#verify_code");
    		
    		img.attr("src", "getVerifyCode.action?i=" + Math.random());
    		
    		img.src = "getVerifyCode.action?i=" + Math.random();
    	};
    };
    
    var r = function(){
    	
    	var elements = $(".register-form").find("input");
	    for (var i = 0; i < elements.length; i++) {
	        elements[i].oninvalid = function(e) {
	            e.target.setCustomValidity("");
	            if (!e.target.validity.valid) {
	                e.target.setCustomValidity(e.target.placeholder + "不能为空！");
	            }
	        };
	        elements[i].oninput = function(e) {
	            e.target.setCustomValidity("");
	        };
	    }
    	
    	$(".register-form input").keypress(function(e) {
			if(13 == e.which){
				$("#register-submit-btn").trigger("click");
			}
			
        }),
    	
    	$(".register-form").bind("submit", function(e){
    		e.preventDefault();
    		
    		if($("#userNameExistError").css("display") == "none" && !$("#re_register_password").closest(".form-group").hasClass("has-error")){
    			 
    			 var userName = $("#regist_username").val();
    			 var password = $("#register_password").val();
    			 
    			 var data = {"userName":userName, "password":password};
    			 
    			 $.ajax({
    				 
    				 type:"post",
    				 url:"registAcount.action",
    				 dataType:"json",
    				 contentType:"application/json",
    				 data:JSON.stringify(data),
    				 success:function(result){
    					 
    					 if(result.status != 0){
    						 $(".regist-defeat").find("span").html(result.message);
    						 $(".regist-defeat").fadeIn();
    					 }
    					 
    					 $(".alert-success").find("span").html(result.message);
    					 window.location.href= "login.action";
    				 },
    				 error:function(result){
    					 $(".regist-defeat").find("span").html("error");
    					 $(".regist-defeat").fadeIn();
    				 }
    			 });
    			 
    		 }
    	}),
    	
    	$("#regist_username").blur(function(){
    		var userName = $("#regist_username").val();
    		
    		var data = {"userName":userName};
    		
    		if(userName != ""){
    			$.ajax({
    				
    				type:"post",
    				url:"checkUserExist.action",
    				dataType:"json",
    				contentType:"application/json",
    				data:JSON.stringify(data),
    				success:function(result){
    					if(result.status != 0){
    						var f = $("#regist_username").closest(".form-group");
    						f.addClass("has-error");
    						$("#userNameExistError").html(result.message);
    						$("#userNameExistError").show();
    					}
    				},
    				error:function(result){
    					alert("error");
    				}
    			});
    		}
    		
    	}),
    	
    	$("#regist_username").on("input",function(){
    		$("#userNameExistError").hide();
    		$("#regist_username").closest(".form-group").removeClass("has-error");
    	}),
    	
    	$("#re_register_password").on("input", function(){
    		var t = $("#re_register_password");
    		var p1 = $("#register_password").val();
    		var p2 = $("#re_register_password").val();
    		
    		if(p1 != p2){
    			t.closest(".form-group").addClass("has-error");
    		}
    		else{
    			t.closest(".form-group").removeClass("has-error");
    		}
    		
    	});
    	
    };
	
    return {
        init: function() {
        	b(),
        	e(),
        	r();
        	$.backstretch(["../assets/pages/media/bg/5.jpg"], {
                fade: 1e3,
                duration: 8e3
            });
        }
    }
	
}();

jQuery(document).ready(function() {
    Login.init()
});
